<!DOCTYPE html>
<html>
<head>
    <title>Quick Test - Electrical Monitoring</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #111; color: #fff; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { background: #222; padding: 15px; border-radius: 8px; min-width: 120px; }
        .stat-label { color: #aaa; font-size: 12px; }
        .stat-value { color: #fff; font-size: 18px; font-weight: bold; }
        #log { background: #000; padding: 10px; border-radius: 4px; font-family: monospace; height: 200px; overflow-y: auto; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>üîå Electrical Monitoring Test</h1>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-label">Rata-rata Voltase</div>
            <div class="stat-value" id="avg-voltage">0 V</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Rata-rata Arus</div>
            <div class="stat-value" id="avg-current">0 A</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Rata-rata Daya</div>
            <div class="stat-value" id="avg-power">0 W</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Status Listrik</div>
            <div class="stat-value" id="electric-status">Normal</div>
        </div>
    </div>
    
    <h3>üìä Live Data Log</h3>
    <div id="log"></div>
    
    <script>
        // Simple electrical stats manager
        class ElectricalStatsManager {
            constructor() {
                this.history = [];
                this.maxHistorySize = 20;
                this.logElement = document.getElementById('log');
            }
            
            log(message) {
                const time = new Date().toLocaleTimeString();
                this.logElement.innerHTML += `[${time}] ${message}<br>`;
                this.logElement.scrollTop = this.logElement.scrollHeight;
            }
            
            updateStats(data) {
                if (!data) return;
                
                const voltage = parseFloat(data.battery_voltage) || 0;
                const current = parseFloat(data.battery_current) || 0;
                const power = parseFloat(data.battery_power) || 0;
                
                this.log(`üìä Received: V=${voltage}V, C=${current}A, P=${power}W`);
                
                // Add to history
                this.history.push({ voltage, current, power });
                if (this.history.length > this.maxHistorySize) {
                    this.history.shift();
                }
                
                // Calculate averages
                const avgVoltage = this.history.reduce((sum, item) => sum + item.voltage, 0) / this.history.length;
                const avgCurrent = this.history.reduce((sum, item) => sum + item.current, 0) / this.history.length;
                const avgPower = this.history.reduce((sum, item) => sum + item.power, 0) / this.history.length;
                
                // Update UI
                document.getElementById('avg-voltage').textContent = `${avgVoltage.toFixed(2)} V`;
                document.getElementById('avg-current').textContent = `${avgCurrent.toFixed(2)} A`;
                document.getElementById('avg-power').textContent = `${avgPower.toFixed(2)} W`;
                
                // Status
                let status = 'Normal';
                if (voltage < 10.5) status = 'Voltage Drop';
                else if (voltage > 13.5) status = 'Overvoltage';
                else if (current > 15) status = 'Overcurrent';
                else if (power > 180) status = 'Overpower';
                
                document.getElementById('electric-status').textContent = status;
                
                this.log(`‚úÖ Updated averages: V=${avgVoltage.toFixed(2)}V, C=${avgCurrent.toFixed(2)}A, P=${avgPower.toFixed(2)}W`);
            }
        }
        
        // Initialize
        const statsManager = new ElectricalStatsManager();
        statsManager.log('üöÄ Test page initialized');
        
        // Socket.IO connection
        const socket = io();
        
        socket.on('connect', () => {
            statsManager.log('üîå Connected to server');
        });
        
        socket.on('telemetryUpdate', (data) => {
            statsManager.log('üì° Received telemetryUpdate');
            statsManager.updateStats(data);
        });
        
        socket.on('telemetryData', (data) => {
            statsManager.log('üì° Received telemetryData (legacy)');
            statsManager.updateStats(data);
        });
        
        socket.on('disconnect', () => {
            statsManager.log('‚ùå Disconnected from server');
        });
        
        // Fallback HTTP polling
        setInterval(async () => {
            try {
                const response = await fetch('/api/telemetry');
                if (response.ok) {
                    const data = await response.json();
                    statsManager.log('üåê HTTP polling data received');
                    statsManager.updateStats(data);
                }
            } catch (error) {
                statsManager.log(`‚ùå HTTP polling error: ${error.message}`);
            }
        }, 5000);
    </script>
</body>
</html>
